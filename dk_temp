In the last two weeks, there have been two deadlocks involving the table DK_TBL_FXSA_TRADES

These deadlocks involve two triggers and 5 procedures in total.

triggers:
------------------------------------------
DK_TR_UPDATE_DK_TBL_FXSA_TRADES
DK_TR_INSERT_DK_TBL_FXSA_TRADES

Both triggers are looking for the DK_TFT_LOCAL_CCY of 'JPY' coming from the Inserted "table" and joining back to DK_TBL_FXSA_TRADES.  In general, triggers of this nature can lead to performance
issues.  DK_TR_UPDATE_DK_TBL_FXSA_TRADES especially uses some innefficient programming practices as it is performing joins based on functions.  This forces row-by-row analysis rather than the generally
more efficient set based.

Procedures:
------------------------------------------
DK_DB_APPS.dbo.DK_SP_FXSA_INSERT_CRD_TRADE
DK_DB_APPS.dbo.DK_SP_FXF_INSERT_FX_SPOT_DETAILS
DK_DB_APPS.dbo.DK_SP_FXFG_SELECT_FILE_DATA
DK_DB_APPS.dbo.DK_SP_FXFG_CFWD_SELECT_JPM_FX_DIRECT_FILE
DK_DB_APPS.dbo.DKG_SP_PCRF_SELECT_FUNDWISE_CUREXPOSURE_REPORT




I do not believe there is much that can be done without altering code.  Below are my suggestions.

* We could create a FILTERED index on DK_TFT_LOCAL_CCY.  This would include a minor alteration to the procedure that I would suggest to have the code for the inserted table reference the 
DK_TFT_LOCAL_CCY column equal to 'JPY'
* We could enable the option to "Allow Snapshot Isolation".  This can be enabled while the database is replicated in AG.  This would allow each transaction to run more autonomously.  This 
does come at a price of row versioning in tempdb.  Enabling this option DOES NOT change a default for the database.  Each of the procedures mentioned above would need to have the line
"set transaction isolation level snapshot" at the beginning of the procedure.
* DK_SP_FXFG_SELECT_FILE_DATA could benefit from possibly altering the index DK_TBL_FXSA_TRADES_DK_TFT_BROKER to include the column DK_TFT_IS_FXSPOT_PENDING_APPROVAL as part of the leaf level of the index.  Either that,
or since this is a smaller table a second index could be added as specified below:

        create  index fd_ix_DK_TBL_FXSA_TRADES_DK_TFT_BROKER
        on      DK_DB_APPS.dbo.DK_TBL_FXSA_TRADES
                (
                DK_TFT_BROKER                   ,
                DK_TFT_STATUS                   ,
                DK_TFT_IS_FXSPOT_PENDING_APPROVAL
                )
        include (
                DK_TFT_ACCOUNT_NO       ,
                DK_TFT_TRADE_AMT        ,
                DK_TFT_ALLOC_AMT        ,
                DK_TFT_ULT_ACCOUNT_NO   ,
                DK_TFT_BATCH_ID         ,
                DK_TFT_MANAGER_CODE
                )
        with    (data_compression = page, fillfactor = 90)

* DK_SP_FXFG_CFWD_SELECT_JPM_FX_DIRECT_FILE would benefit from the following index
        create  index fd_ix_DK_TBL_FXSA_TRADES_DK_TFT_EXTRACTED_UNIQUE_ID
        on      DK_DB_APPS.dbo.DK_TBL_FXSA_TRADES
                (
                DK_TFT_EXTRACTED_UNIQUE_ID
                )
        include (
                DK_TFT_DEPARTMENT
                )
        with    (data_compression = page, fillfactor = 90)


